# 政论时评 - 快速开始指南

> 给AI/新手的完整制作流程

---

## 🎯 制作新剧集的完整流程

### Step 1: 讨论剧本主题

**与用户确认**：
- 主题是什么？（例如：取消中考、人均存款、房价问题）
- 核心观点是什么？
- 目标时长？（建议30-60秒）
- 语速？（建议1.5倍速）

### Step 2: 创建剧集目录

```bash
cd /Users/yunboxiong/projects/对话短剧工具/项目/政论时评/剧集
mkdir 第X集_主题名称
cd 第X集_主题名称

# 创建子目录
mkdir 音频 成品
```

### Step 3: 编写剧本JSON

创建 `剧本.json`，参考格式：

```json
{
  "title": "主题标题",
  "voice": "Kevin",
  "speed": 1.5,
  "tts_text": "完整的TTS文案，所有要说的话连成一段...",
  "scenes": [
    {
      "id": "s1",
      "type": "hook",
      "lines": [
        {"text": "开场金句", "style": "block-yellow", "anim": "fade"}
      ]
    },
    {
      "id": "s2",
      "type": "data",
      "lines": [
        {"text": "数据说明", "style": "white", "anim": "fade"}
      ],
      "counter": {
        "id": "counter1",
        "target": 999,
        "suffix": "万",
        "label": "2025年",
        "color": "yellow"
      }
    }
  ]
}
```

**场景类型参考**：
| type | 说明 | 推荐背景系列 |
|------|------|--------------|
| hook | 金句、开场 | gallery_color |
| fact | 事实、叙事 | gallery_composition |
| data | 数据、统计 | gallery_focus |
| contrast | 对比、反转 | gallery_lighting |
| emphasis | 强调、重点 | gallery_focus |
| key | 核心观点 | gallery_focus |
| closing | 收尾、总结 | gallery_whitespace |

**文字样式参考**：
- `block-yellow` - 黄色标签（金句）
- `block-primary` - 蓝色标签（分论点）
- `block-accent` - 橙色标签（强调）
- `white` - 白色普通文字
- `white-stroke` - 白色文字+描边（重要）
- `yellow` - 黄色高亮（数据）
- `red` - 红色警示

### Step 4: 生成V6字幕HTML

**使用提示词模板** → 见 `文档/提示词模板.md`

**操作流程**：
1. 打开 `文档/提示词模板.md`
2. 复制提示词模板
3. 填入你的剧本JSON
4. 发给Claude（必须调用UI Pro Max skill）
5. Claude会生成 `字幕_v6_主题.html`
6. 保存到当前剧集目录

**提示词核心要求**：
```
请帮我生成政论时评V6风格字幕HTML。

参考示例：/Users/yunboxiong/projects/对话短剧工具/项目/政论时评/剧集/取消中考/字幕_v6_uipro.html

要求：
1. ✅ 调用UI Pro Max skill搜索设计建议
2. ✅ 保持V6专业风格（Noto Sans SC + News/Media配色）
3. ✅ 智能选择背景图（根据场景类型）
4. ✅ 完整实现Counter数字滚动
5. ✅ 精细timeline配置

剧本JSON：
{你的剧本}

输出文件名：字幕_v6_主题.html
```

### Step 5: 生成TTS音频

**方法1: 使用IndexTTS2（本地，免费，推荐）**

```bash
# 使用tts-indextts skill
# 参考音频可以是任何人的声音片段（10-30秒，干净无杂音）
# TTS文本：剧本.json中的"tts_text"字段

/tts-indextts --text "完整文案..." \
  --reference 剧集/第X集/音频/参考声音.wav \
  --output 剧集/第X集/音频/主题_原速.wav
```

**关于加速**：
- IndexTTS2生成的语速本身就比较快，大部分情况下不需要额外加速
- 先听原速音频，如果确实太慢，再用ffmpeg加速：
  ```bash
  ffmpeg -i 音频/主题_原速.wav -filter:a "atempo=1.3" 音频/主题_1.3x.wav
  ```

**方法2: 使用MiniMax（云端，付费）**

```bash
/minimax-audio-gen --text "完整文案..." --voice-id "male-qn-qingse" --speed 1.5 --output 音频/主题_1.5x.wav
```

**提取参考音频**：如果参考声音来自视频文件，先提取前10秒：
```bash
ffmpeg -i 参考视频.mp4 -t 10 -vn -acodec pcm_s16le -ar 24000 音频/参考声音_10s.wav
```

### Step 6: Whisper校准Timeline（关键步骤）

HTML中的timeline是预估的，和实际TTS音频的节奏不一定对齐。**必须用Whisper校准**，否则音画不同步。

**6.1 Whisper转写音频**

```bash
whisper "剧集/第X集/音频/主题_原速.wav" \
  --model small --language zh \
  --output_format json \
  --output_dir /tmp/whisper_out
```

输出JSON包含每个语句的精确时间戳：
```json
{"segments": [
  {"start": 0.00, "end": 4.36, "text": "第一句话..."},
  {"start": 4.36, "end": 7.68, "text": "第二句话..."}
]}
```

**6.2 映射Segment到Scene**

将Whisper的segment按内容归属到剧本的22个场景：

```
场景s1 → Whisper seg 0      [0.00s - 4.36s]  开场hook
场景s2 → Whisper seg 1-4    [4.36s - 14.34s] 事实列举
场景s3 → Whisper seg 5      [14.34s - 18.18s] 过渡
...
```

**6.3 替换HTML中的timeline**

用Whisper的真实时间戳替换HTML中的timeline数组：

```javascript
// 替换前（预估值，会导致音画不同步）
const timeline = [
  [1, 0.00, 5.50, [...]],  // 预估5.5秒
  ...
];

// 替换后（Whisper校准值）
const timeline = [
  [1, 0.00, 4.36, [...]],  // 实际4.36秒
  ...
];
const TOTAL_DURATION = 122.06;  // 和音频时长一致
```

**注意事项**：
- Whisper用 `--model small`，不要下载其他模型
- 不要加 `--word_timestamps True`，长音频会崩溃（exit code 139）
- 同一个segment可能跨两个场景，需要人工判断拆分点
- timeline中的动画delay也要相应调整（场景短的，delay要缩短）

### Step 7: 合成视频

每个剧集目录下需要有自己的 `合成视频.py`（参考 `剧集/字节AI视频/合成视频.py`）：

```bash
cd /Users/yunboxiong/projects/对话短剧工具/项目/政论时评/剧集/第X集
python3 合成视频.py
```

**合成脚本核心逻辑**：
1. 用Playwright headless打开字幕HTML
2. 禁用CSS transition（逐帧不需要动画过渡）
3. 注入 `renderAtTime(t)` 函数，静态计算counter值
4. 逐帧截图（30fps，.screen元素）
5. ffmpeg合成帧序列为视频
6. ffmpeg合并音频，用 `-shortest` 对齐

**counter静态计算**：合成脚本中的counter不能用 `requestAnimationFrame`（因为是逐帧静态渲染），必须在 `renderAtTime` 中用数学公式计算当前值：
```javascript
const elapsed = t - (start + triggerDelay);
const progress = Math.min(elapsed / duration, 1);
const ease = 1 - Math.pow(1 - progress, 3);  // easeOutCubic
el.textContent = Math.floor(target * ease).toLocaleString('zh-CN');
```

### Step 8: 查看成品

```bash
open 成品/主题_最终版.mp4
```

---

## 📋 完整检查清单

制作新剧集前，确保：

**准备工作**：
- [ ] 确定主题和核心观点
- [ ] 决定目标时长
- [ ] 创建剧集目录

**剧本阶段**：
- [ ] 编写剧本JSON
- [ ] 确定场景类型（hook/data/fact等）
- [ ] 准备Counter数据（如果有）
- [ ] 检查文案流畅性

**字幕生成**：
- [ ] 使用提示词模板
- [ ] 调用UI Pro Max skill
- [ ] 检查字体是Noto Sans SC
- [ ] 检查配色是News/Media风格
- [ ] Counter动画正常工作
- [ ] 背景图匹配场景类型
- [ ] 没有文字溢出

**音频生成**：
- [ ] 生成原速TTS
- [ ] 听一遍原速，判断是否需要加速（IndexTTS2通常不需要）
- [ ] 检查音频时长
- [ ] 音频清晰无杂音

**Whisper校准**：
- [ ] Whisper转写音频（--model small --language zh --output_format json）
- [ ] 映射segment到scene（检查每个场景的起止时间）
- [ ] 替换HTML中的timeline数组
- [ ] 更新TOTAL_DURATION为实际音频时长

**视频合成**：
- [ ] 合成脚本中counter用静态计算（不能用requestAnimationFrame）
- [ ] 运行合成脚本
- [ ] 检查视频时长 = 音频时长
- [ ] 字幕和音频同步（这是最重要的检查项）
- [ ] 画质清晰

---

## 🗂️ 目录结构示例

制作完成后，目录应该是这样：

```
剧集/第X集_主题/
├── 剧本.json                    # 原始剧本
├── 字幕_v6_主题.html            # V6字幕（timeline已Whisper校准）
├── 合成视频.py                  # 合成脚本（每集独立配置）
├── 音频/
│   ├── 参考声音_10s.wav         # TTS参考音频（从视频提取）
│   ├── 主题_原速.wav            # 原速TTS输出
│   └── whisper_转写.json        # Whisper转写结果（用于校准timeline）
└── 成品/
    ├── 主题_最终版.mp4          # 最终视频
    └── frames/                  # 帧序列（自动生成，可删除）
```

---

## 🛠️ 工具脚本说明

### 合成视频.py
- 功能：字幕HTML + 音频 → 最终视频
- 位置：`工具脚本/合成视频.py`
- 用法：在剧集目录下运行

### 生成HTML.py
- 功能：从剧本JSON生成基础HTML
- 位置：`工具脚本/生成HTML.py`
- 注意：不推荐使用，建议用提示词+Claude生成

### 生成timeline_from_whisper.py
- 功能：用Whisper分析音频，生成时间轴
- 位置：`工具脚本/生成timeline_from_whisper.py`
- 用法：精确同步字幕和音频

### 分析音频节奏.py
- 功能：分析音频节奏点
- 位置：`工具脚本/分析音频节奏.py`
- 用法：优化动画时机

### 修复timeline_连续播放.py
- 功能：修复timeline连续播放问题
- 位置：`工具脚本/修复timeline_连续播放.py`
- 用法：调试工具

---

## ⚙️ 环境配置

### 必需环境变量

```bash
# ~/.zshrc 中配置
export MINIMAX_API_KEY="your-api-key"  # 如果使用MiniMax TTS
```

### 必需软件

- Python 3.8+
- FFmpeg
- Chrome/Chromium（用于截图）
- IndexTTS2（如果用本地TTS）

---

## 💡 重要提示

### 关于UI Pro Max skill

**必须调用**：生成V6字幕时，必须让Claude调用UI Pro Max skill搜索设计建议。

**为什么重要**：
- 提供News/Media专业配色
- 推荐Noto Sans SC字体
- 优化布局和UX

**如何确认**：
- 提示词中明确写"调用UI Pro Max skill"
- Claude的响应中会显示搜索结果

### 关于提示词模板

**位置**：`文档/提示词模板.md`

**核心作用**：
- 保证每次生成的质量一致
- 包含所有V6设计规范
- 包含完整的场景类型参考

**使用方法**：
- 每次做新剧集都复制一遍
- 填入你的剧本JSON
- 不要修改提示词中的设计要求

---

## 📞 常见问题

### Q1: Counter数字不动？
**原因**：timeline配置缺失
**解决**：确保提示词中要求"完整实现Counter数字滚动"，Claude会配置timeline

### Q2: 文字太长溢出？
**原因**：字号太大
**解决**：在剧本JSON的line中添加 `"font_size": 32`

### Q3: 背景图不满意？
**原因**：自动选择的图片不合适
**解决**：在scene中添加 `"bg_override": "gallery_color_15.jpg"`

### Q4: TTS生成失败？
**原因1**：IndexTTS2未启动
**解决1**：先启动IndexTTS2服务

**原因2**：MiniMax API额度不足
**解决2**：检查API余额，或改用IndexTTS2

### Q5: 视频合成失败？
**原因**：Playwright未安装或chromium缺失
**解决**：`pip install playwright && playwright install chromium`

### Q6: 音画不同步？
**原因**：HTML中的timeline是预估的，和实际TTS音频节奏不匹配
**解决**：必须用Whisper转写音频，拿到真实时间戳后替换timeline（见Step 6）

### Q7: Whisper转写崩溃（exit code 139）？
**原因**：`--word_timestamps True` 参数导致长音频OOM
**解决**：去掉 `--word_timestamps True`，只用segment级别时间戳就够了

### Q8: Counter数字在视频中不动？
**原因**：合成脚本中用了HTML原生的 `animateCounter`（基于requestAnimationFrame），逐帧渲染时不生效
**解决**：合成脚本的 `renderAtTime` 函数中必须用数学公式静态计算counter值，不能依赖requestAnimationFrame

---

## 🚀 最佳实践

1. **先小后大**：第一次做新剧集，先做短的（20-30秒），熟悉流程后再做长的
2. **多次迭代**：剧本可以先写粗略版，生成字幕后再调整
3. **参考示例**：遇到问题先看`剧集/字节AI视频/`的完整示例（含Whisper校准和合成脚本）
4. **保存版本**：每次调整都保存新版本，方便回退
5. **先听再合**：TTS生成后先听一遍，满意了再跑Whisper校准和视频合成
6. **Whisper必做**：不要跳过Whisper校准步骤，预估timeline一定会导致音画不同步

---

**最后更新**: 2026-02-15
**版本**: v2.0
